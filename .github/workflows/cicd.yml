name: CI/CD
on:
  push:
    branches:
      - main

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      build-arm64-json: '[{ "package": "p1", "tenant": null, "architecture": "arm64" },{ "package": "p2", "tenant": "", "architecture": "arm64" },{ "package": "p3", "tenant": "t1", "architecture": "arm64" },{ "package": "p4", "tenant": "t2", "architecture": "arm64" }]'
    steps:
      - name: Build package matrix
        run: echo 'Hello'

  build_test_publish_amd64:
    name: Build amd64
    runs-on: ubuntu-latest
    needs: [setup]
    strategy:
      matrix:
        architecture: ["amd64"]
        include:
          - package: package-1
            tenant: ""
          - package: package-2
            tenant: ""
          - package: package-3
            tenant: "t1"
          - package: package-4
            tenant: "t2"
          - package: package-5
            tenant: ""
    steps:
      - name: Build ${{ matrix.package }} (tenant=${{matrix.tenant}} arch=${{ matrix.architecture }})
        run: echo ./stack build --skip-existing-image --architecture=${{ matrix.architecture }} --tenant="${{matrix.tenant}}" ${{ matrix.package }}

  build_test_publish_arm64:
    name: Build arm64
    runs-on: ubuntu-latest
    needs: [setup]
    strategy:
      matrix:
        include: ${{ fromJSON(needs.setup.outputs.build-arm64-json) }}
    steps:
      - name: Build ${{ matrix.package }} (tenant=${{matrix.tenant}} arch=${{ matrix.architecture }})
        run: echo ./stack build --skip-existing-image --architecture=${{ matrix.architecture }} --tenant="${{matrix.tenant}}" ${{ matrix.package }}

  deploy_dev:
    name: Deploy Dev
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - tenant: "t1"
            packages: "package-1 package-2 package-3"
          - tenant: "t2"
            packages: "package-1 package-2 package-4"
    steps:
      - name: Deploy ${{ matrix.tenant }} (packages=${{matrix.packages}})
        run: echo ./stack deploy --tenant="${{matrix.tenant}}" ${{ matrix.packages }}
